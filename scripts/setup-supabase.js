#!/usr/bin/env node

/**
 * Supabase Migration Setup Script
 * This script helps automate the migration setup process
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import readline from 'readline';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = join(__dirname, '..');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

async function main() {
  console.log('\nüöÄ Supabase Migration Setup\n');
  console.log('This script will help you set up your Supabase migration.\n');

  // Check if .env already exists
  const envPath = join(rootDir, '.env');
  if (existsSync(envPath)) {
    const overwrite = await question('‚ö†Ô∏è  .env file already exists. Overwrite? (y/n): ');
    if (overwrite.toLowerCase() !== 'y') {
      console.log('Skipping .env setup. Using existing file.');
      rl.close();
      return;
    }
  }

  console.log('\nüìã Step 1: Supabase Credentials');
  console.log('Get these from: https://app.supabase.com/project/_/settings/api\n');

  const supabaseUrl = await question('Enter your Supabase Project URL: ');
  if (!supabaseUrl || !supabaseUrl.includes('supabase.co')) {
    console.error('‚ùå Invalid Supabase URL. Should be like: https://xxxxx.supabase.co');
    rl.close();
    process.exit(1);
  }

  const supabaseKey = await question('Enter your Supabase anon/public key: ');
  if (!supabaseKey || !supabaseKey.startsWith('eyJ')) {
    console.error('‚ùå Invalid Supabase key. Should start with "eyJ"');
    rl.close();
    process.exit(1);
  }

  // Create .env file
  const envContent = `# Supabase Configuration
# Generated by setup-supabase.js

VITE_SUPABASE_URL=${supabaseUrl.trim()}
VITE_SUPABASE_PUBLISHABLE_KEY=${supabaseKey.trim()}
`;

  writeFileSync(envPath, envContent);
  console.log('\n‚úÖ Created .env file with your credentials\n');

  // Update config.toml
  const configPath = join(rootDir, 'supabase', 'config.toml');
  if (existsSync(configPath)) {
    const projectId = supabaseUrl.match(/https:\/\/([^.]+)\.supabase\.co/)?.[1];
    if (projectId) {
      const configContent = `# Supabase Project Configuration
# Updated by setup-supabase.js

project_id = "${projectId}"
`;
      writeFileSync(configPath, configContent);
      console.log('‚úÖ Updated supabase/config.toml\n');
    }
  }

  console.log('üìù Next Steps:');
  console.log('1. Run database migration (see MIGRATION_GUIDE.md)');
  console.log('2. Configure authentication (see AUTHENTICATION_MIGRATION.md)');
  console.log('3. Test your app: npm run dev\n');

  rl.close();
}

main().catch(console.error);


